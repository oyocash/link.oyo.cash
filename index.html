<html>
<head>
<script src="common.js"></script>
<script src="https://www.moneybutton.com/moneybutton.js"></script>
<script type="text/javascript" src="https://unpkg.com/bsv@0.27.2/bsv.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">

</head>
<body>
<div class="container is-fluid">
  <div class="tile is-ancestor">
    <div class="tile is-parent is-12">
      <article class="tile is-child box">
        <p class="content" id="tx_hash"></p>
        <p class="title" id="title"></p>
        <div class="content" id="paid">
          <p>
            <div id="moneybuttons"></div>
          </p>
          <p class="subtitle" id="timer"></p>
        </div>
        <div class="content" id="free">
          <p>
            <div id="realLinks"></div>
          </p>
        </div>
      </article>
    </div>
  </div>

<script language='javascript'>
  var address = "149xadSKJcKdhgE4sMmcvx421nsGYwgkWo"
  var amount = 0.008
  var currency = "USD"
  var type = "default"
  var appName = "default"
  var appUrl = "https://link.oyo.cash/?tx={tx_hash}"
  var opReturnScript = bsv.Script.buildDataOut([address, type, appName, appUrl]).toASM()

  var countdown = 15; // seconds
  var links = []

  var appendMoneybutton = function(id) {
    var p = document.createElement("p");
    var div = document.createElement("div");
    document.getElementById("moneybuttons").appendChild(p).appendChild(div);
    moneyButton.render(div, {
      label: links[id][0],
      successMessage: "Redirecting...",
      buttonId: id+1,   // buttonId cannot be 0
      onPayment: paymentReceived,
      outputs: [
      {
        type: "tip",
        to: address,
        currency: currency,
        amount: amount
      }, {
        type: "SCRIPT",
        script: opReturnScript,
        amount: "0",
        currency: "BSV"
      }]
    })
  }
  var appendRealLink = function(id) {
    var p = document.createElement("p");
    var div = document.createElement("div");
    var a = document.createElement("a");
    var aText = document.createTextNode(links[id][0]);
    a.setAttribute("href", links[id][1]);
    a.appendChild(aText);
    document.getElementById("realLinks").appendChild(p).appendChild(div).appendChild(a);
  }
  var paymentReceived = function(payment) {
    var id = payment.buttonId - 1   // fix for buttonId cannot be 0
    var win = window.open(links[id][1], '_blank');
    win.focus();
//    window.location.replace(links[id][1]);
  }

  document.getElementById("free").style.display = "none";
  document.getElementById("paid").style.display = "none";
  if (getUrlVars() !== undefined && getUrlVars()["tx"] !== undefined && getUrlVars()["tx"].match(/^[0-9a-fA-F]{64}$/)) {
    // Get tx from neongenesis
    var query = {
      "v": 3,
      "q": {
        "find": { "tx.h": getUrlVars()["tx"] },
        "project": { "out": 1 }
      }
    }
    var b64 = btoa(JSON.stringify(query));
    var url = "https://babel.bitdb.network/q/1DHDifPvtPgKFPZMRSxmVHhiPvFmxZwbfh/" + b64;
    var header = { headers: { key: "1Ma7jy7deP3WvBqD8PwGqrZkAh4BBsP758" } };

    fetch(url, header).then(function(r) {
      return r.json()
    }).then(function(r) {
      // tx not found
      if (r.c === undefined || r.c.length !== 1) {
        document.getElementById("title").innerHTML = "Transaction not found"
        return 0
      }
      // Memo
      if (r.c[0].out[0].h1 === "6d02" || r.c[0].out[0].h1 === "6d03") {
        links.push(["Memo", "https://memo.sv/post/" + getUrlVars()["tx"]])
//        links.push(["Poster", "https://poster.cash/post/" + getUrlVars()["tx"]])
      }
      // b
      if (r.c[0].out[0].s1 === "19HxigV4QyBv3tHpQVcUEQyq1pzZVdoAut") {
        links.push(["Bico.media", "https://bico.media/" + getUrlVars()["tx"]])
      }
      // bcat
      if (r.c[0].out[0].s1 === "15DHFxWZJT58f9nhyGnsRBqrgwK4W6h4Up") {
        links.push(["Bico.media", "https://bico.media/" + getUrlVars()["tx"]])
      }
      // Twetch
//      if () {
//        links.push(["Twetch", "http://twetch.app/t/" + getUrlVars()["tx"]])
//      }
      // Weather.sv
      if (r.c[0].out[0].s1 === "1LtyME6b5AnMopQrBPLk4FGN8UBuhxKqrn") {
        links.push(["Weathersv.app", "https://weathersv.app/channel/" + r.c[0].out[0].s4])
      }
      // populate default links
      links.push(["Blockchair", "https://blockchair.com/bitcoin-sv/transaction/" + getUrlVars()["tx"]])
      links.push(["Whatsonchain", "https://whatsonchain.com/tx/" + getUrlVars()["tx"]])
      links.push(["Bchsvexplorer", "https://bchsvexplorer.com/tx/" + getUrlVars()["tx"]])

      console.log(links)

      for (let i = 0; i < links.length; ++i) {
        appendMoneybutton(i)
        appendRealLink(i)
      }
    })

    document.getElementById("tx_hash").innerHTML = getUrlVars()["tx"]
    document.getElementById("title").innerHTML = "Open with"
    document.getElementById("paid").style.display = "block";

    var countdownInterval = setInterval(function() {
      countdown--;
      if (countdown > 0) {
        document.getElementById("timer").innerHTML = "...or wait " + countdown + " seconds";
      } else {
        clearInterval(countdownInterval);
        document.getElementById("free").style.display = "block";
        document.getElementById("paid").style.display = "none";
      }
    }, 1000);
  } else {
    document.getElementById("title").innerHTML = "Not a valid transaction hash"
  }

  document.addEventListener("DOMContentLoaded", function() {
  })
</script>
</body>
</html>
